/* (c) Jonathan Gotti - licence: https://github.com/malko/d.js/LICENCE.txt @version 0.3.0*/
(function(n){"use strict";function e(n){r(function(){throw n})}function t(n,e){var t=i(n);if(1===t.length&&t[0]instanceof Array){if(!t[0].length)return f.fulfilled([]);t=t[0]}var r=[],o=f(),u=t.length;if(u)for(var c=(function(n){t[n]=f.promisify(t[n]),t[n].then(function(i){n in r||(r[n]=e?t[n]:i,--u||o.resolve(r))},function(i){n in r||(e?(r[n]=e?t[n]:v,--u||o.resolve(r)):o.reject(i))})}),s=0,l=u;l>s;s++)c(s);else o.resolve(r);return o.promise}var r,o=function(n){return n instanceof Function},u=function(e){return e===!1||e===n||null===e},i=function(n,e){return[].slice.call(n,e)},c="undefined";if(typeof process!==c&&process.nextTick)r=process.nextTick;else if(typeof MessageChannel!==c){var s=new MessageChannel,l=[];s.port1.onmessage=function(){l.length&&l.shift()()},r=function(n){l.push(n),s.port2.postMessage(0)}}else r=function(n){setTimeout(n,0)};var f=function(t){function i(){if(0!==h){var n,e=p,t=0,r=e.length,o=~h?0:1;for(p=[];r>t;t++)(n=e[t][o])&&n.call(null,l)}}function c(n){return h?this:n&&o(n.then)?(n.then(c,s),this):(a(function(){l=n,h=1,i()}),this)}function s(n){return 0===h&&a(function(){try{throw n}catch(e){l=e}h=-1,i()}),this}var l,a=(n!==t?t:f.alwaysAsync)?r:function(n){n()},h=0,p=[],v=f.onlyFuncs,y={then:function(n,e){var t=f();return p.push([function(e){try{u(n)?t.resolve(e):t.resolve(o(n)?n.call(null,e):v?e:n)}catch(r){t.reject(r)}},function(n){if((u(e)||!o(e)&&v)&&t.reject(n),e)try{t.resolve(o(e)?e.call(null,n):e)}catch(r){t.reject(r)}}]),0!==h&&a(i),t.promise},success:function(e){return this.then(e,n)},error:function(e){return this.then(n,e)},apply:function(e,t){return this.then(function(n){return o(e)?e.apply(null,n):v?n:e},t||n)},rethrow:function(t){return this.then(n,t?function(n){throw t(n),n}:e)},isPending:function(){return!(0!==h)},getStatus:function(){return h}};return y.toSource=y.toString=y.valueOf=function(){return l===n?this:l},{promise:y,resolve:c,fulfill:c,reject:s}};f.defer=f,f.nextTick=r,f.alwaysAsync=!0,f.onlyFuncs=!0,f.resolved=f.fulfilled=function(n){return f(!0).resolve(n).promise},f.rejected=function(n){return f(!0).reject(n).promise},f.wait=function(n){var e=f();return setTimeout(e.resolve,n||0),e.promise},f.delay=function(n,e){var t=f();return setTimeout(function(){try{t.resolve(n.apply(null))}catch(e){t.reject(e)}},e||0),t.promise},f.promisify=function(n){return n&&o(n.then)?n:f.resolved(n)},f.all=function(){return t(arguments,!1)},f.resolveAll=function(){return t(arguments,!0)},f.nodeCapsule=function(n,e){return e||(e=n,n=void 0),function(){var t=f(),r=i(arguments);r.push(function(n,e){n?t.reject(n):t.resolve(arguments.length>2?i(arguments,1):e)});try{e.apply(n,r)}catch(o){t.reject(o)}return t.promise}},typeof window!==c?window.D=f:module.exports=f})();
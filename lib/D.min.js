/* (c) Jonathan Gotti - licence: https://github.com/malko/d.js/LICENCE.txt */
!function(){"use strict";function a(a){b(function(){throw a})}Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){for(var c=b||0,d=this.length;d>c;c++)if(this[c]===a)return c;return-1});var b,c=function(a){return a instanceof Function},e=function(a){return!!~[void 0,null,!1].indexOf(a)},f=function(a,b){return[].slice.apply(a,b)},g="undefined",h="length",i="promise",j="resolve",k="reject",l="then";if(typeof process!==g&&process.nextTick)b=process.nextTick;else if(typeof MessageChannel!==g){var m=new MessageChannel,n=[];m.port1.onmessage=function(){n[h]&&n.shift()()},b=function(a){n.push(a),m.port2.postMessage(0)}}else b=function(a){setTimeout(a,0)};var o=function(d){function f(a){a&&a.call(null,p)}function g(){if(0!==q){var a=r,b=0,c=a[h],d=~q?0:1;for(r=[];c>b;b++)f(a[b][d])}}function m(a){return q?this:a&&c(a[l])?(a[l](m,n),this):(p=a,q=1,d?b(g):g(),this)}function n(a){if(0!==q)return this;try{throw a}catch(c){p=c}return q=-1,d?b(g):g(),this}d||(d=o.alwaysAsync);var p,q=0,r=[],s=o.onlyFuncs,t={then:function(a,f){var h=o();return r.push([function(b){try{h[j](e(a)?b:c(a)?a.call(null,b):s?b:a)}catch(d){h[k](d)}},function(a){if((e(f)||!c(f)&&s)&&h[k](a),f)try{h[j](c(f)?f.call(null,a):f)}catch(b){h[k](b)}}]),0!==q&&(d?b(g):g()),h[i]},success:function(a){return this[l](a,null)},error:function(a){return this[l](null,a)},apply:function(a,b){return this[l](function(b){return c(a)?a.apply(null,b):s?b:a},b||null)},rethrow:function(b){return this[l](null,b?function(a){throw b(a),a}:a)},isPending:function(){return 0===q?!0:!1},getStatus:function(){return q}};return t.toSource=t.toString=t.valueOf=function(){return void 0===p?this:p},{promise:t,resolve:m,fulfill:m,reject:n}};o.defer=o,o.nextTick=b,o.alwaysAsync=!0,o.onlyFuncs=!0,o.resolved=o.fulfilled=function(a){return o(!0)[j](a)[i]},o.rejected=function(a){return o(!0)[k](a)[i]},o.wait=function(a){var b=o();return setTimeout(b[j],a||0),b[i]},o.delay=function(a,b){var c=o();return setTimeout(function(){try{c[j](a.apply(null))}catch(b){c[k](b)}},b||0),c[i]},o.promisify=function(a){return a&&c(a[l])?a:d.resolved(a)},o.all=function(){var a=arguments;if(1===a[h]&&a[0]instanceof Array){if(a[0][h])return o.all.apply(o,a[0]);var b=o();return b[j](a[0]),b[i]}var c=[],d=o(),e=f(a),g=e[h];if(g)for(var m=0,n=g;n>m;m++)!function(a){var b=o.promisify(e[a]);b[l](function(b){a in c||(c[a]=b,--g||d[j](c))},function(b){a in c||d[k](b)})}(m);else d[j](c);return d[i]},o.nodeCapsule=function(a,b){return b||(b=a,a=void 0),function(){var c=o(),d=f(arguments);d.push(function(a,b){a?c[k](a):c[j](arguments[h]>2?f(arguments,1):b)});try{b.apply(a,d)}catch(e){c.reject(e)}return c[i]}},typeof window!==g?window.D=o:module.exports=o}();